/**
 * Database Authentication Adapter (Example)
 * This is an example of how to create additional authentication adapters
 * following the Zend Framework adapter pattern
 */
class Database {
    constructor(dbConnection, tableName, usernameColumn = 'username', passwordColumn = 'password') {
        this.dbConnection = dbConnection;
        this.tableName = tableName;
        this.usernameColumn = usernameColumn;
        this.passwordColumn = passwordColumn;
        this.username = null;
        this.password = null;
        this.resultInfo = {
            code: null,
            identity: null,
            messages: []
        };
    }

    /**
     * Set username for authentication
     * @param {string} username 
     * @returns {Database}
     */
    setUsername(username) {
        this.username = username;
        return this;
    }

    /**
     * Set password for authentication
     * @param {string} password 
     * @returns {Database}
     */
    setPassword(password) {
        this.password = password;
        return this;
    }

    /**
     * Set credentials for authentication
     * @param {string} username 
     * @param {string} password 
     * @returns {Database}
     */
    setCredentials(username, password) {
        this.username = username;
        this.password = password;
        return this;
    }

    /**
     * Perform authentication
     * @returns {object} Authentication result
     */
    async authenticate() {
        // Reset result info
        this.resultInfo = {
            code: null,
            identity: null,
            messages: []
        };

        // Validate input
        if (!this.username || !this.password) {
            this.resultInfo.code = 'FAILURE_CREDENTIAL_INVALID';
            this.resultInfo.messages.push('Username and password are required');
            return this.createResult();
        }

        try {
            // Example database query (adapt to your database library)
            const query = `SELECT * FROM ${this.tableName} WHERE ${this.usernameColumn} = ?`;
            const user = await this.dbConnection.query(query, [this.username]);

            if (!user || user.length === 0) {
                this.resultInfo.code = 'FAILURE_IDENTITY_NOT_FOUND';
                this.resultInfo.messages.push('Username not found');
                return this.createResult();
            }

            // Verify password (in production, use bcrypt or similar)
            if (user[0][this.passwordColumn] !== this.password) {
                this.resultInfo.code = 'FAILURE_CREDENTIAL_INVALID';
                this.resultInfo.messages.push('Invalid password');
                return this.createResult();
            }

            // Authentication successful
            this.resultInfo.code = 'SUCCESS';
            this.resultInfo.identity = {
                id: user[0].id,
                username: user[0][this.usernameColumn],
                email: user[0].email || null,
                role: user[0].role || 'user'
            };
            this.resultInfo.messages.push('Authentication successful');

            return this.createResult();

        } catch (error) {
            console.error('Database Adapter error:', error);
            this.resultInfo.code = 'FAILURE_UNCATEGORIZED';
            this.resultInfo.messages.push('Database authentication error');
            return this.createResult();
        }
    }

    /**
     * Create authentication result object
     * @returns {object}
     */
    createResult() {
        const isValid = this.resultInfo.code === 'SUCCESS';
        
        return {
            _code: this.resultInfo.code,
            _isValid: isValid,
            _identity: this.resultInfo.identity,
            _messages: this.resultInfo.messages,
            
            getCode: function() { return this._code; },
            isValid: function() { return this._isValid; },
            getIdentity: function() { return this._identity; },
            getMessages: function() { return this._messages; }
        };
    }
}

module.exports = Database;